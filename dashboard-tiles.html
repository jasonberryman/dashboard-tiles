<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../date-display/date-display.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../dashboard-tile/dashboard-tile.html">
<link rel="import" href="../text-avatar/text-avatar.html">
<link rel="import" href="../count-up/count-up.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `<dashboard-tiles></dashboard-tiles>` demo
  @demo demo.html
-->
<dom-module id="dashboard-tiles">
  <template>
    <style>
      :host {
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
      }
    </style>
    <template is="dom-if" if="[[!list.length]]">
      loading .. / no dashboard tiles
    </template>
    <template is="dom-repeat" items="{{list}}">
      <dashboard-tile item="[[item]]" dash-ref="{{item.theData}}"></dashboard-tile>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "dashboard-tiles",
    properties:{
      list:{
        type: Array,
        value:[],
      },
      name:{
        type: String,
        value:"test.user",
      },
      customerDomain:{
        type: String,
        value:"example.com",
      },
      description:{
        type: String,
      },
      getReady:{
        computed: "setup(userRef)",
      },
      list:{
        computed: "setList(allDashs, go)",
      },
      go: {
        value:"",
      },
    },
    mergeData: function(data) {
      var output = {}
      for (var theSet in data) {
        for (var lert in data[theSet]) {
          if (data[theSet].hasOwnProperty(lert)) { 
            if (!output[lert]) {
              output[lert] = data[theSet][lert]
            } else if ( output[lert] < +data[theSet][lert] && +data[theSet][lert] < (24 * 60 * 60 * 1000) ) { // prefer bigger, not date
              output[lert] = data[theSet][lert]
            } else if ( output[lert] > +data[theSet][lert] && +data[theSet][lert] > (24 * 60 * 60 * 1000) ) { // prefer earlier, date
              output[lert] = data[theSet][lert]
            } else if (+data[theSet][lert] === 0) {
              output[lert] = data[theSet][lert]
            }
          }
        }
      }
      return output
    },
    setList: function(allDashs){
      var output = []
      if (allDashs) {
        var keys = Object.keys(allDashs)
        for (var i = 0; i < keys.length; i++) {
          output.push(allDashs[keys[i]])
        }
      }
      return output
    },
    setup: function(userRef){
      this.allDashs = {}
      if (!this.unSubDash) {
        this.unSubDash = {}
      }
      if (userRef){
        var that = this
        for (var unSubDash in this.unSubDash) {
          this.unSubDash[unSubDash]()
        }
        if (this.unSubDashs) {
          this.unSubDashs()
        }
        var theDashData = {}
        this.unSubDashs = userRef.collection('dashboards').onSnapshot(function(dashboard) {
          if (dashboard) {
            for (var index in dashboard.docs) {
              var theData = dashboard.docs[index].data()
              var alerts = {
                callsQueueing:  theData.callsQueueing,
                longestWaiting: theData.longestWaiting,
              }
              if (theData.displayName) {
                if (!theDashData[" "]) {
                  theDashData[" "] = {}
                }
                theDashData[" "].displayName = theData.displayName
              }          
              if (theData.description) {
                if (!theDashData[" "]) {
                  theDashData[" "] = {}
                }
                theDashData[" "].description = theData.description
              }
              
              if (theData.photoUrl) {
                if (!theDashData[" "]) {
                  theDashData[" "] = {}
                }
                theDashData[" "].photoUrl = theData.photoUrl
              }
              
              
              var dashKey = dashboard.docs[index].key
              var dashRef = dashboard.docs[index].ref
              var directorySource = theData.directorySource
              
              for (var dash in directorySource) {
                if (that.unSubDash[directorySource[dash]]) {
                  that.unSubDash[directorySource[dash]]()
                }
                that.unSubDash[directorySource[dash]] = firebase.firestore().collection('directory')
                .doc(directorySource[dash])
                .onSnapshot(function(doc) {
                  if (doc) {
                    theDashData[directorySource[dash]] = doc.data()
                    var mergedData = that.mergeData(theDashData)
                    that.allDashs[dashKey] = {
                      data: mergedData, 
                      alerts: alerts,
                      directorySource: dash,
                      dashKey: dashKey,
                      dashRef: dashRef,
                    }
                    that.go = !that.go
                  } else {
                    console.log("No such document!")
                  }
                })
              }
            }
          }
        })
      }
    },
  })
</script>
