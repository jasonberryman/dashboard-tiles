<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../date-display/date-display.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../text-avatar/text-avatar.html">
<link rel="import" href="../count-up/count-up.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `<calls-queueing></calls-queueing>` demo
  @demo demo.html
-->
<dom-module id="calls-queueing">
  <template>
    <style>
      :host {
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
      }
    </style>
    <template is="dom-if" if="[[!list.length]]">
      loading ..
    </template>
    <template is="dom-repeat" items="{{list}}">
      <paper-material elevation="1" style$="background-color:[[bgColor]];color:[[fgColor]];display:inline-block;margin:10px;width:300px;height:250px;color:[[item.textColor]];background-size:cover;background-image:url('[[item.photoURI]]')">
        <paper-item style="background-color: rgba(255, 255, 255, 0.85);">
          <paper-icon-item>
            <text-avatar item-icon name="[[item.primaryName]]"></text-avatar>
          </paper-icon-item>
          <paper-item-body style="color:#333" two-line>
            <div>[[item.primaryName]]</div>
            <template is="dom-if" if="[[item.description]]">
              <div secondary>[[item.description]]</div>
            </template>
          </paper-item-body>
        </paper-item>
        <table style="width:100%;margin-top:5px">
          <tr>
            <td style="vertical-align: bottom;padding-left:15px ;text-align: left">
              <div style="line-height: 1;font-size:4em;font-weight:800">[[item.callsQueueing]]</div>
            </td>
            <template is="dom-if" if="[[item.longestWaiting]]">
              <td style="vertical-align: bottom; padding-right:15px; text-align:right">
                <count-up style="font-size:32px" from="[[item.longestWaiting]]"></count-up>
              </td>
            </template>
            <template is="dom-if" if="[[!item.longestWaiting]]">
              <td style="vertical-align: bottom;padding-right:15px ;text-align:right">
                No Waiting
              </td>
            </template>
          </tr>
          <tr>
            <td style="padding-left:15px;text-align:left"> 
              <div>calls queueing</div>
            </td>
            <template is="dom-if" if="[[item.longestWaiting]]">
              <td style="padding-right:15px;text-align:right">
                <div>longest wait</div>
              </td>
            </template>
          </tr>
        </table>
        <table cellpadding="4" style="display:block;width: 100%;
        height: 70px; background-color: rgba(255, 255, 255, 0.85);
        position: absolute;top: 180px;text-align: left;
        color: #383838;bottom: 0;"><tbody style="display: block;width: 100%">
          <tr style="font-size: .6em;">
            <th colspan="2">Answered</th>
            <th>Abandoned</th>
            <th>Calls per hour</th>
          </tr>
          <tr>
            <td style="color:#2828bd">95%</td>
            <td style="color:#2828bd">308 <span style="font-size:.6em;">calls</span></td>
            <td style="color:red"    >16 <span style="font-size:.6em;">calls</span></td>
            <td rowspan="2"><img style="max-width:110px" src$="[[background]]"/></td>
          </tr>
          <tr style="font-size: .6em;">
            <td colspan="3">last 24 hours</td>
          </tr>
        </tbody></table>
      </paper-material>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "calls-queueing",
    properties:{
      list:{
        type: Array,
        value:[],
      },
      name:{
        type: String,
        value:"test.user",
      },
      customerDomain:{
        type: String,
        value:"example.com",
      },
      description:{
        type: String,
      },
      photoURL:{
        value: "https://firebasestorage.googleapis.com/v0/b/dolphin-one-fstest2.appspot.com/o/pexels-photo-383617.jpg?alt=media&token=1ef57e5f-27b0-4254-95da-ddd171abaedb",
      },
      getReady:{
        computed: "setup(userRef)",
      },
      background:{
        value: "https://firebasestorage.googleapis.com/v0/b/dolphin-one-fstest2.appspot.com/o/blue%20line.png?alt=media&token=60c3eb2b-ca67-4d1a-8a5b-02e83d170655",
      },
      list:{
        computed: "setList(allDashs,go)",
      },
      go: {
        value:"",
      },
      bgColor: {
        value:"#006600",
      },
      fgColor: {
        computed:"getFg(bgColor)",
      },
    },
    setList: function(allDashs){
      var output = []
      if (allDashs) {
        var keys = Object.keys(allDashs)
        for (var i = 0; i < keys.length; i++) {
          output.push(allDashs[keys[i]])
        }
      }
      return output
    },
    setup: function(userRef){
      this.allDashs = {}
      if (userRef){
        var that = this
        var unsub = {}
        
        userRef.collection('dashboards').onSnapshot(function(dashboard) {
          if (dashboard) {
            for (var index in dashboard.docs) {
              var dash = dashboard.docs[index].data().directorySource
              // add unsub there
              unsub[dash] = firebase.firestore().collection('directory')
              .doc(dash)
              .onSnapshot(function(doc) {
                if (doc) {
                  that.allDashs[dash] = doc.data()
                  that.go = !that.go
                } else {
                  console.log("No such document!")
                }
              })
            }
          }
        })
      }
    },
    getFg: function(bg){
      var c = bg.substring(1);     // strip #
      var rgb = parseInt(c, 16);   // convert rrggbb to decimal
      var r = (rgb >> 16) & 0xff;  // extract red
      var g = (rgb >>  8) & 0xff;  // extract green
      var b = (rgb >>  0) & 0xff;  // extract blue
      var luma = 0.2126 * r + 0.7152 * g + 0.0722 * b; // per ITU-R BT.709
      if (luma > 128) {
        return "#000"
      } else {
        return "#FFF"
      }
    },
  })
</script>
